/**
 * VULNERABILITY ASSESSMENT TOOL
 *
 * Security vulnerability calculations: CVSS scoring,
 * risk assessment, attack surface analysis.
 *
 * Part of TIER CYBERSECURITY - Ultimate Tool Arsenal
 */

import type { UnifiedTool, UnifiedToolCall, UnifiedToolResult } from '../providers/types';

// ============================================================================
// CVSS 3.1 CALCULATIONS
// ============================================================================

interface CVSSMetrics {
  attackVector: 'N' | 'A' | 'L' | 'P';
  attackComplexity: 'L' | 'H';
  privilegesRequired: 'N' | 'L' | 'H';
  userInteraction: 'N' | 'R';
  scope: 'U' | 'C';
  confidentialityImpact: 'N' | 'L' | 'H';
  integrityImpact: 'N' | 'L' | 'H';
  availabilityImpact: 'N' | 'L' | 'H';
}

const CVSS_VALUES = {
  attackVector: { N: 0.85, A: 0.62, L: 0.55, P: 0.2 },
  attackComplexity: { L: 0.77, H: 0.44 },
  privilegesRequired: {
    unchanged: { N: 0.85, L: 0.62, H: 0.27 },
    changed: { N: 0.85, L: 0.68, H: 0.5 },
  },
  userInteraction: { N: 0.85, R: 0.62 },
  impact: { N: 0, L: 0.22, H: 0.56 },
};

function calculateCVSS(metrics: CVSSMetrics): { score: number; severity: string; vector: string } {
  const AV = CVSS_VALUES.attackVector[metrics.attackVector];
  const AC = CVSS_VALUES.attackComplexity[metrics.attackComplexity];
  const PR = metrics.scope === 'C'
    ? CVSS_VALUES.privilegesRequired.changed[metrics.privilegesRequired]
    : CVSS_VALUES.privilegesRequired.unchanged[metrics.privilegesRequired];
  const UI = CVSS_VALUES.userInteraction[metrics.userInteraction];

  const C = CVSS_VALUES.impact[metrics.confidentialityImpact];
  const I = CVSS_VALUES.impact[metrics.integrityImpact];
  const A = CVSS_VALUES.impact[metrics.availabilityImpact];

  // Exploitability
  const exploitability = 8.22 * AV * AC * PR * UI;

  // Impact
  const ISCbase = 1 - ((1 - C) * (1 - I) * (1 - A));
  const ISC = metrics.scope === 'C'
    ? 7.52 * (ISCbase - 0.029) - 3.25 * Math.pow(ISCbase - 0.02, 15)
    : 6.42 * ISCbase;

  // Base Score
  let score: number;
  if (ISC <= 0) {
    score = 0;
  } else if (metrics.scope === 'C') {
    score = Math.min(10, 1.08 * (ISC + exploitability));
  } else {
    score = Math.min(10, ISC + exploitability);
  }

  // Round up to 1 decimal
  score = Math.ceil(score * 10) / 10;

  let severity = 'None';
  if (score >= 9.0) severity = 'Critical';
  else if (score >= 7.0) severity = 'High';
  else if (score >= 4.0) severity = 'Medium';
  else if (score > 0) severity = 'Low';

  const vector = `CVSS:3.1/AV:${metrics.attackVector}/AC:${metrics.attackComplexity}/PR:${metrics.privilegesRequired}/UI:${metrics.userInteraction}/S:${metrics.scope}/C:${metrics.confidentialityImpact}/I:${metrics.integrityImpact}/A:${metrics.availabilityImpact}`;

  return { score, severity, vector };
}

// ============================================================================
// RISK ASSESSMENT
// ============================================================================

function riskScore(likelihood: number, impact: number): { score: number; level: string } {
  // Both on 1-5 scale
  const score = likelihood * impact;
  let level = 'Low';
  if (score >= 20) level = 'Critical';
  else if (score >= 12) level = 'High';
  else if (score >= 6) level = 'Medium';

  return { score, level };
}

function annualizedLossExpectancy(assetValue: number, exposureFactor: number, annualRateOfOccurrence: number): {
  sle: number;
  ale: number;
} {
  const sle = assetValue * exposureFactor; // Single Loss Expectancy
  const ale = sle * annualRateOfOccurrence; // Annualized Loss Expectancy

  return { sle, ale };
}

// ============================================================================
// ATTACK SURFACE METRICS
// ============================================================================

function attackSurfaceScore(
  endpoints: number,
  openPorts: number,
  userInputs: number,
  thirdPartyDeps: number,
  privilegedAccounts: number
): { score: number; level: string } {
  // Weighted scoring
  const score = (endpoints * 3) + (openPorts * 2) + (userInputs * 4) + (thirdPartyDeps * 2) + (privilegedAccounts * 5);

  let level = 'Minimal';
  if (score > 100) level = 'Critical';
  else if (score > 50) level = 'High';
  else if (score > 25) level = 'Medium';
  else if (score > 10) level = 'Low';

  return { score, level };
}

// ============================================================================
// VULNERABILITY CLASSIFICATIONS
// ============================================================================

const CWE_TOP_25: Record<number, { name: string; category: string; mitigation: string }> = {
  787: { name: 'Out-of-bounds Write', category: 'Memory', mitigation: 'Bounds checking, safe functions' },
  79: { name: 'Cross-site Scripting (XSS)', category: 'Injection', mitigation: 'Output encoding, CSP' },
  89: { name: 'SQL Injection', category: 'Injection', mitigation: 'Parameterized queries' },
  416: { name: 'Use After Free', category: 'Memory', mitigation: 'Memory-safe languages, smart pointers' },
  78: { name: 'OS Command Injection', category: 'Injection', mitigation: 'Input validation, avoid shell' },
  20: { name: 'Improper Input Validation', category: 'Validation', mitigation: 'Whitelist validation' },
  125: { name: 'Out-of-bounds Read', category: 'Memory', mitigation: 'Bounds checking' },
  22: { name: 'Path Traversal', category: 'Injection', mitigation: 'Canonicalization, sandbox' },
  352: { name: 'CSRF', category: 'Session', mitigation: 'Anti-CSRF tokens' },
  434: { name: 'Unrestricted Upload', category: 'Injection', mitigation: 'File type validation' },
};

function lookupCWE(cweId: number): { name: string; category: string; mitigation: string } | null {
  return CWE_TOP_25[cweId] || null;
}

// ============================================================================
// TOOL DEFINITION
// ============================================================================

export const vulnerabilityTool: UnifiedTool = {
  name: 'vulnerability',
  description: `Vulnerability assessment and security scoring.

Operations:
- cvss: Calculate CVSS 3.1 score from metrics
- risk: Risk assessment calculations
- attack_surface: Attack surface analysis
- cwe: Look up CWE information
- ale: Calculate Annualized Loss Expectancy`,

  parameters: {
    type: 'object',
    properties: {
      operation: {
        type: 'string',
        enum: ['cvss', 'risk', 'attack_surface', 'cwe', 'ale'],
        description: 'Vulnerability operation',
      },
      attack_vector: { type: 'string', enum: ['N', 'A', 'L', 'P'], description: 'Attack Vector (Network/Adjacent/Local/Physical)' },
      attack_complexity: { type: 'string', enum: ['L', 'H'], description: 'Attack Complexity (Low/High)' },
      privileges_required: { type: 'string', enum: ['N', 'L', 'H'], description: 'Privileges Required (None/Low/High)' },
      user_interaction: { type: 'string', enum: ['N', 'R'], description: 'User Interaction (None/Required)' },
      scope: { type: 'string', enum: ['U', 'C'], description: 'Scope (Unchanged/Changed)' },
      confidentiality: { type: 'string', enum: ['N', 'L', 'H'], description: 'Confidentiality Impact' },
      integrity: { type: 'string', enum: ['N', 'L', 'H'], description: 'Integrity Impact' },
      availability: { type: 'string', enum: ['N', 'L', 'H'], description: 'Availability Impact' },
      likelihood: { type: 'number', description: 'Likelihood (1-5)' },
      impact: { type: 'number', description: 'Impact (1-5)' },
      endpoints: { type: 'number', description: 'Number of endpoints' },
      open_ports: { type: 'number', description: 'Number of open ports' },
      user_inputs: { type: 'number', description: 'Number of user input points' },
      third_party_deps: { type: 'number', description: 'Number of third-party dependencies' },
      privileged_accounts: { type: 'number', description: 'Number of privileged accounts' },
      cwe_id: { type: 'number', description: 'CWE ID' },
      asset_value: { type: 'number', description: 'Asset value ($)' },
      exposure_factor: { type: 'number', description: 'Exposure factor (0-1)' },
      annual_rate: { type: 'number', description: 'Annual rate of occurrence' },
    },
    required: ['operation'],
  },
};

// ============================================================================
// EXECUTOR
// ============================================================================

export async function executeVulnerability(toolCall: UnifiedToolCall): Promise<UnifiedToolResult> {
  const { id, arguments: rawArgs } = toolCall;

  try {
    const args = typeof rawArgs === 'string' ? JSON.parse(rawArgs) : rawArgs;
    const { operation } = args;

    let result: Record<string, unknown>;

    switch (operation) {
      case 'cvss': {
        const metrics: CVSSMetrics = {
          attackVector: args.attack_vector || 'N',
          attackComplexity: args.attack_complexity || 'L',
          privilegesRequired: args.privileges_required || 'N',
          userInteraction: args.user_interaction || 'N',
          scope: args.scope || 'U',
          confidentialityImpact: args.confidentiality || 'H',
          integrityImpact: args.integrity || 'H',
          availabilityImpact: args.availability || 'H',
        };

        const cvss = calculateCVSS(metrics);

        result = {
          operation: 'cvss',
          version: '3.1',
          metrics: {
            attack_vector: metrics.attackVector,
            attack_complexity: metrics.attackComplexity,
            privileges_required: metrics.privilegesRequired,
            user_interaction: metrics.userInteraction,
            scope: metrics.scope,
            confidentiality_impact: metrics.confidentialityImpact,
            integrity_impact: metrics.integrityImpact,
            availability_impact: metrics.availabilityImpact,
          },
          score: cvss.score,
          severity: cvss.severity,
          vector_string: cvss.vector,
          severity_scale: {
            'None': '0.0',
            'Low': '0.1 - 3.9',
            'Medium': '4.0 - 6.9',
            'High': '7.0 - 8.9',
            'Critical': '9.0 - 10.0',
          },
        };
        break;
      }

      case 'risk': {
        const { likelihood = 3, impact = 4 } = args;
        const risk = riskScore(likelihood, impact);

        result = {
          operation: 'risk',
          likelihood: likelihood,
          impact: impact,
          risk_score: risk.score,
          risk_level: risk.level,
          risk_matrix: {
            rows: ['Impact 5', 'Impact 4', 'Impact 3', 'Impact 2', 'Impact 1'],
            cols: ['Like 1', 'Like 2', 'Like 3', 'Like 4', 'Like 5'],
            current_cell: `(${likelihood}, ${impact})`,
          },
          recommendation: risk.level === 'Critical' ? 'Immediate action required' :
                          risk.level === 'High' ? 'Priority remediation' :
                          risk.level === 'Medium' ? 'Plan remediation' : 'Monitor and accept',
        };
        break;
      }

      case 'attack_surface': {
        const {
          endpoints = 10,
          open_ports = 5,
          user_inputs = 15,
          third_party_deps = 50,
          privileged_accounts = 3
        } = args;

        const surface = attackSurfaceScore(endpoints, open_ports, user_inputs, third_party_deps, privileged_accounts);

        result = {
          operation: 'attack_surface',
          components: {
            api_endpoints: { count: endpoints, weight: 3, score: endpoints * 3 },
            open_ports: { count: open_ports, weight: 2, score: open_ports * 2 },
            user_inputs: { count: user_inputs, weight: 4, score: user_inputs * 4 },
            third_party_dependencies: { count: third_party_deps, weight: 2, score: third_party_deps * 2 },
            privileged_accounts: { count: privileged_accounts, weight: 5, score: privileged_accounts * 5 },
          },
          total_score: surface.score,
          risk_level: surface.level,
          recommendations: [
            user_inputs > 10 ? 'Review all user input validation' : null,
            third_party_deps > 30 ? 'Audit third-party dependencies' : null,
            privileged_accounts > 5 ? 'Review privileged access' : null,
            open_ports > 10 ? 'Minimize exposed services' : null,
          ].filter(Boolean),
        };
        break;
      }

      case 'cwe': {
        const { cwe_id = 79 } = args;
        const cwe = lookupCWE(cwe_id);

        result = {
          operation: 'cwe',
          cwe_id: cwe_id,
          found: !!cwe,
          details: cwe || { name: 'Unknown CWE', category: 'Unknown', mitigation: 'Consult CWE database' },
          common_cwe_list: Object.entries(CWE_TOP_25).slice(0, 10).map(([id, info]) => ({
            id: Number(id),
            name: info.name,
            category: info.category,
          })),
        };
        break;
      }

      case 'ale': {
        const { asset_value = 100000, exposure_factor = 0.3, annual_rate = 0.5 } = args;
        const { sle, ale } = annualizedLossExpectancy(asset_value, exposure_factor, annual_rate);

        result = {
          operation: 'ale',
          inputs: {
            asset_value: asset_value,
            exposure_factor: exposure_factor,
            annual_rate_of_occurrence: annual_rate,
          },
          calculations: {
            single_loss_expectancy: Math.round(sle),
            annualized_loss_expectancy: Math.round(ale),
          },
          interpretation: {
            sle_meaning: 'Expected loss from single incident',
            ale_meaning: 'Expected annual loss from this risk',
            security_budget_guidance: `Consider controls costing less than $${Math.round(ale)}/year`,
          },
        };
        break;
      }

      default:
        throw new Error(`Unknown operation: ${operation}`);
    }

    return { toolCallId: id, content: JSON.stringify(result, null, 2) };
  } catch (error) {
    return { toolCallId: id, content: `Vulnerability Error: ${error instanceof Error ? error.message : 'Unknown'}`, isError: true };
  }
}

export function isVulnerabilityAvailable(): boolean { return true; }
