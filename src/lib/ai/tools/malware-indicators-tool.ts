/**
 * MALWARE INDICATORS TOOL
 * Indicators of Compromise (IoC) analysis - Educational/Defensive
 */
/* eslint-disable @typescript-eslint/no-unused-vars */

import type { UnifiedTool, UnifiedToolCall, UnifiedToolResult } from '../providers/types';

const IOC_TYPES = ['ip', 'domain', 'url', 'hash_md5', 'hash_sha1', 'hash_sha256', 'email', 'filename', 'registry', 'mutex'];

function classifyIoc(value: string): string {
  if (/^[a-f0-9]{32}$/i.test(value)) return 'hash_md5';
  if (/^[a-f0-9]{40}$/i.test(value)) return 'hash_sha1';
  if (/^[a-f0-9]{64}$/i.test(value)) return 'hash_sha256';
  if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(value)) return 'ip';
  if (/^https?:\/\//.test(value)) return 'url';
  if (/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value)) return 'domain';
  if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'email';
  if (/\.(exe|dll|sys|bat|ps1|vbs|js)$/i.test(value)) return 'filename';
  return 'unknown';
}

function extractIocs(text: string): Record<string, string[]> {
  const iocs: Record<string, string[]> = { ip: [], domain: [], url: [], hash: [], email: [] };
  const ipRegex = /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g;
  const urlRegex = /https?:\/\/[^\s<>"{}|\\^`\[\]]+/g;
  const hashRegex = /\b[a-f0-9]{32,64}\b/gi;
  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
  const domainRegex = /(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}/g;
  iocs.ip = [...new Set(text.match(ipRegex) || [])];
  iocs.url = [...new Set(text.match(urlRegex) || [])];
  iocs.hash = [...new Set(text.match(hashRegex) || [])];
  iocs.email = [...new Set(text.match(emailRegex) || [])];
  iocs.domain = [...new Set((text.match(domainRegex) || []).filter(d => !iocs.email.some(e => e.includes(d))))];
  return iocs;
}

function defangIoc(value: string): string {
  return value.replace(/\./g, '[.]').replace(/http/g, 'hxxp').replace(/@/g, '[@]');
}

function refangIoc(value: string): string {
  return value.replace(/\[\.\]/g, '.').replace(/hxxp/g, 'http').replace(/\[@\]/g, '@');
}

export const malwareIndicatorsTool: UnifiedTool = {
  name: 'malware_indicators',
  description: 'Malware IoC: classify, extract, defang, refang (educational/defensive)',
  parameters: { type: 'object', properties: { operation: { type: 'string', enum: ['classify', 'extract', 'defang', 'refang', 'types'] }, value: { type: 'string' }, text: { type: 'string' } }, required: ['operation'] },
};

export async function executeMalwareIndicators(toolCall: UnifiedToolCall): Promise<UnifiedToolResult> {
  const { id, arguments: rawArgs } = toolCall;
  try {
    const args = typeof rawArgs === 'string' ? JSON.parse(rawArgs) : rawArgs;
    let result: Record<string, unknown>;
    switch (args.operation) {
      case 'classify': result = { type: classifyIoc(args.value || '') }; break;
      case 'extract': result = { iocs: extractIocs(args.text || '') }; break;
      case 'defang': result = { defanged: defangIoc(args.value || '') }; break;
      case 'refang': result = { refanged: refangIoc(args.value || '') }; break;
      case 'types': result = { ioc_types: IOC_TYPES }; break;
      default: throw new Error(`Unknown: ${args.operation}`);
    }
    return { toolCallId: id, content: JSON.stringify(result, null, 2) };
  } catch (e) { return { toolCallId: id, content: `Error: ${e instanceof Error ? e.message : 'Unknown'}`, isError: true }; }
}
export function isMalwareIndicatorsAvailable(): boolean { return true; }
