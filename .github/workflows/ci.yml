name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['main']

jobs:
  # ============================================
  # JOB 1: Type Check, Lint, and Build
  # ============================================
  typecheck-lint-build:
    runs-on: ubuntu-latest
    name: Typecheck, Lint & Build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Typecheck
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run lint

      - name: Build
        run: pnpm run build | tee build-output.txt
        env:
          SKIP_ENV_VALIDATION: true
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          SUPABASE_SERVICE_ROLE_KEY: placeholder-service-role-key

      - name: Check bundle size budgets
        run: |
          # Extract First Load JS shared size (in kB)
          SHARED_SIZE=$(grep 'First Load JS shared' build-output.txt | grep -oP '[\d.]+\s*kB' | head -1 | grep -oP '[\d.]+')
          echo "First Load JS shared: ${SHARED_SIZE} kB"

          # Budget: First Load JS shared must be under 120 kB
          BUDGET=120
          if [ -n "$SHARED_SIZE" ]; then
            OVER=$(echo "$SHARED_SIZE > $BUDGET" | bc -l 2>/dev/null || echo 0)
            if [ "$OVER" = "1" ]; then
              echo "::error::First Load JS shared (${SHARED_SIZE} kB) exceeds budget (${BUDGET} kB)"
              exit 1
            fi
            echo "::notice::Bundle size OK: ${SHARED_SIZE} kB / ${BUDGET} kB budget"
          else
            echo "::warning::Could not parse bundle size from build output"
          fi

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Run Unit Tests with Coverage
        run: pnpm test -- --coverage
        env:
          SKIP_ENV_VALIDATION: true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ============================================
  # JOB 3: E2E Tests (Playwright)
  # ============================================
  e2e-tests:
    runs-on: ubuntu-latest
    name: E2E Tests
    needs: typecheck-lint-build # Run after build succeeds

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build Application
        run: pnpm run build
        env:
          SKIP_ENV_VALIDATION: 'true'
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          SUPABASE_SERVICE_ROLE_KEY: placeholder-service-role-key

      - name: Run E2E Tests
        run: pnpm exec playwright test
        env:
          CI: 'true'
          SKIP_ENV_VALIDATION: 'true'
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          SUPABASE_SERVICE_ROLE_KEY: placeholder-service-role-key
          ANTHROPIC_API_KEY: placeholder-api-key
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ============================================
  # JOB 4: Security Audit
  # ============================================
  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Run security audit
        run: |
          # Run audit at critical level (blocks on critical vulns with available patches)
          # Known unfixable vulns (no patched version exists):
          #   - xlsx 0.18.5: SheetJS abandoned npm distribution (GHSA-4r6h, GHSA-5pgg)
          #   - mathjax-node 2.1.1: unmaintained, pulls vulnerable mathjax/qs/form-data
          #   - next 14.x: fix requires major upgrade to 15.x (tracked separately)
          # All fixable high/critical vulns are resolved via pnpm overrides and direct upgrades.
          pnpm audit --audit-level=critical 2>&1 || true
          # Fail on any NEW critical vulnerabilities with available patches
          CRITICAL_COUNT=$(pnpm audit --audit-level=critical --json 2>/dev/null | python3 -c "
          import json, sys
          try:
            data = json.load(sys.stdin)
            advisories = data.get('advisories', {})
            fixable = [a for a in advisories.values()
                       if a.get('severity') == 'critical'
                       and a.get('patched_versions', '<0.0.0') != '<0.0.0']
            print(len(fixable))
          except:
            print(0)
          " 2>/dev/null || echo 0)
          echo "Fixable critical vulnerabilities: $CRITICAL_COUNT"
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT fixable critical vulnerabilities. Run 'pnpm audit' locally."
            exit 1
          fi
          echo "::notice::Security audit passed. Known unfixable vulns documented in CI config."
